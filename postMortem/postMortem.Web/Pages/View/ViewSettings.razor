@page "/Settings";
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@inject postMortemWorker Worker
@inject IAuthenticationProvider Auth;

<h3>Account settings</h3>

<EditForm Model=@Settings OnSubmit=@FormSubmitted>
    <DataAnnotationsValidator />
    <ServerSideValidator @ref=validator />

    <Switch @bind-Value="Settings.UseDarkMode" Label="Use dark mode" />
    <Switch @bind-Value="Settings.ShowNSFWContent" Label="Show NSFW content" />
    <Switch @bind-Value="Settings.PrivateAccount" Label="Private account" />
    <ValidationSummary />

    <br/>
    <input type="submit" class="btn btn-primary" value="Save" />
</EditForm>

@code
{
    ServerSideValidator validator;

    /// <summary>
    /// The current user object.
    /// </summary>
    private User CurrentUser { get; set; }
    private UserSettings Settings { get; set; } = new UserSettings();

    /// <summary>
    /// Initialize the component.
    /// </summary>
    /// <returns></returns>
    protected override async Task OnInitializedAsync()
    {
        CurrentUser = await Auth.GetUser();
        Settings = CurrentUser.Settings;

        StateHasChanged();
    }

    /// <summary>
    /// Save the page changes.
    /// </summary>
    /// <param name="editContext"></param>
    private async void FormSubmitted(EditContext editContext)
    {
        CurrentUser.Settings = Settings;
        Worker.SaveChanges();
    }
}
